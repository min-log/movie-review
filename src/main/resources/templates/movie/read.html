<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layoutBasic}">

<th:block layout:fragment="content">
  <link rel="stylesheet" th:href="@{/css/starrr.css}" src="../../static/css/starrr.css">
  <link rel="stylesheet" th:href="@{http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css}">


  <script type="text/javascript" th:src="@{/js/starrr.js}" src="../../static/js/starrr.js"></script>
  <div class="movie_image_wrap">
    <ul class="movie_slider">
      <li th:each="movieImage : ${dto.imageDTOList}">
        <img th:if="${movieImage.path != null}" th:src="|/display?fileName=${movieImage.getImageURL()}|" alt="">
      </li>
    </ul>
  </div>
  <div class="line-move"></div>
  <div class="container movie_info">
    <div class="my-5">
      <h4 class="h4 border-bottom pb-3" th:text="${dto.title}">ì˜í™” ì œëª©</h4>
      <div class="form-group mt-3 movie_info_con">
        <p>í‰ì  : <span th:text="${dto.avg}">í‰ì </span></p>
        <p>ì¡°íšŒìˆ˜ : <span th:text="${dto.reviewCnt}">ì¡°íšŒìˆ˜</span></p>
      </div>
    </div>
  </div>

  <!-- movie_image_wrap -->
  <p class="border-top"></p>
  <!-- ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ -->
  <div class="container review_form my-5">
        <input type="hidden" name="mid" id="mid" value="1">
        <h4 class="h4 border-bottom pb-3" >ğŸ˜ " [[${dto.title}]] " ë¦¬ë·°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”.</h4>
        <div class="form-group mt-3">
          <label class="form-label">ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”. 'click!!'</label>
          <div class='starrr'></div>
        </div>
        <div class="form-group mt-4">
          <label class="form-label">ê°ìƒí‰ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.</label>
          <input type="text" class="form-control review_txt" aria-label="file example" name="title" placeholder="ì˜í™” ë¦¬ë·°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”." required>
        </div>
        <button type="button" id="reviewSave" class="btn btn-primary mt-3" style="width:100%">ì €ì¥</button>
  </div>

  <div class="review_wrap">
    <div class="container">

    </div>
    <div class="bg-full">
      <div class="container review_wrap pt-5">
          <h4 class="h4 border-bottom pb-3">ğŸ‘€ "[[${dto.title}]] " ë¦¬ë·°
            <span class="total">[[${dto.reviewCnt}]] ê°œ</span>
          </h4>
          <div class="review_list"></div>
      </div>
    </div>
  </div>
  <script>
    $(document).ready(function (e){
        // ìŠ¬ë¼ì´ë“œ =======================================================
        $('.movie_slider').slick();

        // ë¦¬ë·° =======================================================
        let grade = 0; //ì ìˆ˜
        let mno = [[${dto.mno}]];// ì˜í™”ë²ˆí˜¸
        let inputMid = $('input#mid');//ê³ ê°ë²ˆí˜¸
        let inputText = $('input.review_txt');//text

        // ë³„ì  ì„ íƒ ê¸°ëŠ¥
        $('.starrr').starrr({
            rating: grade,
            change: function(e, value){
                if (value){
                  grade = value;
                }
            }
        });

        // ë¦¬ë·° ì €ì¥
        $("#reviewSave").on('click',function (){
            console.log(inputText.val())
            if (inputText.val() == null || inputText.val() == ""){
              alert("ë¦¬ë·° ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.")

            }else{
              let data = {mno:mno, grade:grade,text:inputText.val(),mid:inputMid.val()}
              console.log(data);
               $.ajax({
                   url:'/reviews/'+mno,
                   type:'POST',
                   data: JSON.stringify(data),
                   contentType: 'application/json; charset=utf-8',
                   dataType:"text",
                   success:function (result){
                       console.log("result : "+result);
                       self.location.reload();// ì¬ ë¡œë”©
                   }
               });
            }
        });


        // í˜ì´ì§€ê°€ ìƒˆë¡œ ë¡œë”©ë˜ì—ˆì„ë•Œ ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ ë³´ì—¬ì£¼ê¸°
        function getMovieReviews(){
            function formatTime(str){
                let data = new Date(str);
                return data.getFullYear() + '/' +
                    (data.getMonth() + 1) + '/' +
                    data.getDate() + ' ' +
                    //ì‹œê°„
                    data.getHours() + ':' +
                    data.getMinutes();
            }


            $.getJSON("/reviews/"+mno+"/all",function (arr){
               let str = '';
               $.each(arr,function (idx,review){
                  console.log(review);
                  str += '<div class="my-3 p-3 bg-body rounded shadow-sm" data-reveiwnum="' + review.reviewnum + '" data-mid="' + review.mid + '">';
                    str += '            <p class="nickname "> '+ review.nickname +'</p>';
                    str += '            <p class="txt mt-2"> '+ review.text +'</p>';
                    str += '            <div class="review_info mt-2">';
                      str += '                <p class="score" >'+ review.grade +'</p>';
                      str += '                <p class="date">' + formatTime(review.regDate)  +'</p>';
                    str +=    '         </div>';
                    str += '            <div class="review_btn mt-3 text-right">';
                    str += '             <button id="reviewModify" class="btn btn-dark btn-sm" type="button">ìˆ˜ì •</button>'
                    str += '             <button onClick="reviewDelete()" class="btn btn-secondary btn-sm" type="button">ì‚­ì œ</button>'
                    str +=    '         </div>';
                  str += '</div>'
               });

               $('.review_list').html(str);
            });
        }

        getMovieReviews();
    });
  </script>
</th:block>

</html>